---
import "../../styles/global.css";
---

<html lang="en">
	<head
		><meta charset="utf-8" /><meta
			name="viewport"
			content="width=device-width, initial-scale=1"
		/><title>Journal • SoulLog</title></head
	>
	<body>
		<main class="max-w-2xl mx-auto p-4 space-y-6">
			<header class="flex items-center justify-between">
				<h1 class="text-2xl font-semibold">Journal</h1>
				<a href="/app/checkin" class="text-sm underline">Check-in</a>
			</header>
			<section class="card p-4">
				<h2 class="font-medium mb-2">Your last 10 entries</h2>
				<ul id="list" class="space-y-2"></ul>
			</section>
		</main>
		<script type="module">
			import { browserSupabase } from "../../lib/supabaseClient";
			import {
				deriveRootKey,
				unwrapDEK,
				decryptJSON,
			} from "/src/lib/crypto/e2ee.ts";
			import { getOrCreateSalt } from "/src/lib/crypto/storage.ts";

			const supabase = browserSupabase();

			const { data: session } = await supabase.auth.getSession();
			if (!session.session) location.href = "/auth/login";

			const list = document.getElementById("list");
			async function rootKey() {
				const salt = getOrCreateSalt();
				let pwd = sessionStorage.getItem("soulog_pwd");
				if (!pwd) {
					pwd =
						prompt("Enter your password to unlock encryption") ||
						"";
					sessionStorage.setItem("soulog_pwd", pwd);
				}
				return deriveRootKey(pwd, salt);
			}
			const rk = await rootKey();

			async function load() {
				const { data, error } = await supabase
					.from("journal_entries")
					.select("*")
					.order("created_at", { ascending: false })
					.limit(10);
				if (error) return;
				list.innerHTML = "";
				for (const row of data) {
					const dek = await unwrapDEK(
						rk,
						new Uint8Array(row.dek_wrap_iv),
						new Uint8Array(row.dek_wrapped)
					);
					const plain = await decryptJSON(
						dek,
						new Uint8Array(row.iv),
						new Uint8Array(row.cipher)
					);
					const li = document.createElement("li");
					li.className =
						"flex items-center justify-between p-2 rounded-xl hover:bg-sand-100";
					li.innerHTML = `<div><div class="text-sm">${new Date(row.created_at).toLocaleString()}</div><div class="text-slate-700">${plain.text}</div></div><div class="text-xl">${["", "😢", "😟", "😐", "🙂", "😄"][row.mood]}</div>`;
					const del = document.createElement("button");
					del.textContent = "Delete";
					del.className = "ml-3 text-sm underline";
					del.onclick = async () => {
						await supabase
							.from("journal_entries")
							.delete()
							.eq("id", row.id);
						await load();
					};
					li.appendChild(del);
					list.appendChild(li);
				}
			}
			load();
		</script>
	</body>
</html>
